# Implementation Plan

- [x] New invoice states:
    - `ready`
        - This is to flag invoices that have been pre-validated and are ready to be paid
    - `failed`
        - To flag invoices that have failed for some reason
- [x] New fields on invoices:
    - `nextRetry` (datetime)
        - For failed invoices, determines when the invoice should be processed again
- [x] New notification service
    - Just a mock service, not actually implemented
    - Allows queuing up notifications to be sent to either an account owner or to a system admin
- [x] Create new submodule for batch processing
    - Add dependency on Quartz
    - Define placeholder job definitions
- [x] Support updating existing invoices
    - Only some fields are editable (`status` & `nextRetry`)
- [x] Add `creationTime` field to invoices
    - This is set to `now()` on creation and cannot be changed
- [x] Implement `BillingService` class to process invoices
- [x] New recurring job to pay invoices
    - Runs on the first day of the month
    - Finds all "ready" invoices and tries to pay them
    - Only grab invoices where the creation date is before the end of the previous month
    - Delegate processing of each invoice to the `BillingService`
- [x] New invoice validation service
- [ ] New recurring job to pre-validate invoices
    - Runs every hour
    - Can be run on-demand (by using an API)
    - Finds all "pending" invoices and validates them
    - Invoices that fail validation have their state set to "failed" (see error-handling for more behaviour)
    - Invoices that pass validation get their state set to "ready"
- [ ] Rename `retryTime` to something like `retryPaymentAfter`
- [ ] Update jobs to ensure they cannot run multiple times in parallel
- [ ] New recurring job to retry payment of failed invoices
    - Runs every hour
    - Finds all invoices with "failed" status and a non-null and past `retryTime` and processes them again
    - Try to pay the invoice if validations pass
    - When a failed invoice goes from "failed" to "paid", send a notification to the admin
- [ ] New `rest/v1/invoices/{id}/retry` API
    - New API endpoint to retry paying a given invoice
    - This ignores the next retry value
    - Will throw an exception if the invoice status is not "failed"
    - Will throw an exception if the invoice is not yet due (i.e. not from before the start of the month)
- [ ] New `rest/v1/invoices/{id}/retry-validation` API
    - Re-validates the given invoice using the same logic as the batch job
